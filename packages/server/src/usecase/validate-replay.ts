import { TRPCError } from "@trpc/server"
import { and, eq } from "drizzle-orm"
import { Buffer } from "node:buffer"
import { ReplayModel } from "runtime/proto/replay"
import { WorldModel } from "runtime/proto/world"
import { validateReplay } from "runtime/src/model/replay/validateReplay"
import { z } from "zod"
import { replays } from "../db-schema"
import { worlds } from "../domain/worlds"
import { publicProcedure } from "../trpc"

export const validateReplayProcedure = publicProcedure
    .input(
        z
            .object({
                world: z.string(),
                gamemode: z.string(),
                replay: z.string(),
            })
            .required(),
    )
    .mutation(async ({ input, ctx: { db } }) => {
        const world = worlds.find(world => world.id.name === input.world)

        if (!world) {
            console.log("world not found: " + input.world)

            throw new TRPCError({
                message: "World not found",
                code: "BAD_REQUEST",
            })
        }

        const replayBuffer = Buffer.from(input.replay, "base64")

        const replayModel = ReplayModel.decode(replayBuffer)
        const worldModel = WorldModel.decode(Buffer.from(world.model, "base64"))

        const stats = validateReplay(replayModel, worldModel, input.gamemode)

        if (!stats) {
            console.log("replay is invalid")

            throw new TRPCError({
                message: "Replay is invalid",
                code: "BAD_REQUEST",
            })
        }

        // alina;("101351381146300019516900417216310316630165175163174163301573115731161174163102166311651741671741631741631741631741632071673716613516637166135166371661351663716623416613516637166135166135166371661351661351661951657516719516513516637166135166371661351661351663716613516613616613516637166135166135166371661351661351661351663716613516637166135383738233383738135383738135381363836382343813538373837381353813538135383738135383738135381353837381363836381363836381363813538135381353837383738002037166135166135166371662341663716695161254168003823338973723338763919437136381943713538003296165371663716613516637166135166135166371661351661351661351663716613516613616636166136166751672341660017373813538373813538373813538135380015174392543613638363813638135381353837381353837380091353837381353837382333837381353823438194373738004135166233166195165135166371661351663716623316600241353813538135383738135381353813538373837381353813638233381953713538373813538135383738135381353800286461353813638135383738363813638135380047971651351661351663716613516637166009030157301571741631741633116531165102166174167195169101713117317116300103115731165311691017112316817316300331157003174353137102381743931373137174351743530333133313330293129313317435313330333133312930293133312917435312930290042312931333029174353133313330333129312900631291023812340174391234031372929002231290013129004174163174167174167103170194169123168174163006311573015700263029313331333137303731371743531371743510238313710238103381023817439174391033817439174393137102383137303717535313710238313730373137174351753510238174393137313730330083137314110430011844617539312900531290033029004174163174163174163174163174163311571741633116131161174163102166103166174167194173002411721761671741710023116917416710216617416731165174167311653016532157001631157003130157003012316800141172001113173001204172001195173001174171101711741673215731157003174163002311570019311570043129312931293133303331333133303317435313331333133174353137303710338303731371743531333133302931293133001302931293129001313330330011954117339314119441114319441314112340102381743531293129006831157123168101711951691731673215700153115700631293133302900261743531331743530293133003531290099302910242314510246214620544194413033001031290073115717416331161311611741633116510216617416331161174163311651231683016919516910171101711231724117231161005311611951691941691741671231683116510216610316610216610216610316617416330161008311611021661231681741671741671751630013312931293133001302931293029313331333033314130370053133174353229313330293133313730373137313710238103383037175353033313300131333137303710338174393037323330290024531157174163311653016510316610216631165311651021663116510216631165311653016517516330161321573015700943115717416331157311570022174163311651731633116531165102166102166103166001102170311653116531165301611741633116131161311613016531165175163301610043115700123115700631293137102381023812340123403141304110342102423141195411733910338303717535303300110338303317435302917435174353129001831290011741630011231682017400111317300132157006301570033115700117435001204600182480011143314500130410011743500131290023129312931333033312931290053129001631161102166195169001174171194169176163301613116131157311613016131161311573015731161311611741633016131161311570044311570033129313710238313717435174351234017439314119441195411024200117443175353133001717416312316817416731169194169195169101711741711741713116910216632161002230157003311570063137102421143414441441043102421234010238313331291743517435103383037103381733500303129002312900331290083116117416317416317416331165301653216130157003311570043015700731157195169174171194173144178194173411721021703016500631157002313330293129313330293129002174351234031411944110342304112340123401743912340102381743912340123401743931371743530293133174353137174391023831371743500930333137174393141173391753500403129001731169123168301693116532161009301573116130161311611741633116530165175167174167301653116531161311613015731161301573115731157001301570014302931293129312930293129312900131333029312930293129312930293133312900181743531331234017335313331290048174390021234030290033133313710238102383137102383137313317435312931290014302900543129002311571741630013116930165311731021701021701951691741673015700831157002312931293129005302900111743510338304100117543102383037175351023810338174391743917439313730333029008312917435174353133002817435102381033830373233302900143115731161001030157311653016531161321573015731157174163004311573116530165311653116517416300203015700146311573115731165301653116912316819416910316631161005311571741631021661741671231681231681741630017311570033129313331371733510338303717439103381023817439313717435312900553029003311613016131161001043133174351743531371733517439001174391743917539102381023832293129002031331023810338102383137174353037175353129313330293129006313330371033817439174393137303300163137313730371753530290011312931157174163008102166175163174163174163102166103166174167123168174167123168102166174163004174163311651741630053015700283115717416330157174163311651741633116130157005311613015731157301570093115700723129302900793015700130293133004117435102383137174353133312900530293129008312931290013115717416317416317416331165301613215700159312900231293129302900431161301613116131157311613015731157002817416300120174123172017610317017416300313029313730371033810238103381023812340314119441195411024231411944131411234019541304131411234030373329001430290023129001174167123168123168174167301653116132157301570051174163311691017119516930169311653215700293133174351743517435313330293129302931333133174353029312900203115731161301571741633116100131165123168301653116500430157003331290013137314100119445114331411733931371743500193129001311613016131165102166174167002164176102170195169194169123168311653016100131157003531291743517439174391743910338303331333029004312900131290020311651021661031663016517516330161006311611741631741633116131161301613215730157311571741633116510216612316800241172301570033116130157174163311570011311570051174353133174351023817535313330330043229313717439123403041195411954110238303710338173351743531373137102383137174353033174351753517435302900143129313317435313730371753510238174353137313717335313731333033312900831291023812340174433141123401733500531290012311573116117416310216612316819516917417131173112177195173311731231721017112316831165301570024174167311651741631741633015700103116131157301573116130157311573115731157001301573115731161301610013215700591743510338174393141304131411234017439174351743517435174351023817535006302931333133303317435313300203129003311613116100530157311613015731157001141172174171411721231721231681011660015321570012302931333029313700130290073137123401944100203329004311613015731161301613116117416331157311613015731157311613016131165174163174163174163311613116100130157004311613015700131157311610011741671021661751633116517316331161311610038312931331743912344314130413141123401743912344102383037175351743531333029312931331743517435313730373133312900831291023817539174393037313331290093129174353137102381743919541123401733917535003302900741172411724117212316829161003311610013115700431165101711231722017493175101752051721731713116931165005301570073133001174391234031372929302931290013129174353129174353137174391234030411034210431744310342304112340313731330013312917435314110432054417443174431234029330043129001231161301571017111171112173017600110179114173917119516931169102166174167301610013174351023812340103381743917439174393141304112340175390011944117635174351023810338174391744317435303332290020311613116131165102166102166103166174163301610033115731157174163311653016512316817416719516930169175167001130157311573116131161301613115731157311613015700110216631165103166174167173163311570033115700171741633116510216631165311610035322930293129001312900231293033313317435174393137174391023810338174391743931373037103383137303710338303717535302900531331743510238103381743931371733500131290011743531371023817439103381743931411224010338175351743531331023819541104310431034212240123401033810238103381743910238175353029001931290013116110216617416712316831169311691941691951691731671031661021661231683116912316830165301613115700131161311653116919416919516919416919516917416717316332157001301570083116512316810217012316831169174167173163004311573115731157001931157311613016517516719416910317030169331610023015731161311653016510316610216610216610316631165301613115700323129312931333137102381743910242114310431744310431954119441314112340314117339123403141123401234030371023817439314110431954110242123401743910238175353029313331333137102381234031411744341441744317447174393033001331290031741633115731161301573115731161311651731631741673116100113116519416910317019416912316812316817416710316612316810216617416719516930165311653016531165174167001311693016100243015731165174167311691231683016500153015700831157301613116510216610316610216631157311570093137314110242123401234017335174351743531371743912340174391023817435174351743517535302931330013311573115731161311611741631021661741671231681741671741671031661731630053115731157311613016100732157301571741633116100131157003330157002331331743517435174351743517435313331371733531373033001313300431291743531371743500117435001030293129006102166001113173001301690011331570011743500131371743910430011753500431331743500133029002312900551741631741671951691941691741670011031660033015700731157001102166311653116510216617516300330157001174163311611741633116530165311650013116930165103166123168102166301610033115731161001174163174163311651021663116100431157001312910238314141441944541441234441441034217439312900471741633116912316830169103166311570051741633116110216617516317416317416331157174163174163001123168301651017131169123168123168311652915731157001831293029001312900163129174351023812340102421143174433141122401753917439174391234012340174391023812340102383141104341441047175391743531293129001313330371234019541102423141194411234012340174393137313330293129312917435312930293133004312900930290011741633116910217010317017417100119416931169101713117320174101751117519416917416731157311570013116100130161321573015731157001311573015731157311570024174163311651941691751711017119416917516331157008311613015731161002531291743931411024219541102383033003312931333133303331293129003417439174391033830373229005313710238123403141123401224010338175353029001431157102166174167311691951691011663216100817535123401043123441744317439303733290033133303731413141123401744330370053129002302900230161311613116117416331157001030157311611741631741671231681231681231681231681021661741671741671231681231681021701017111317300120178195173195173174171102170103166301651751633116130157002931157311611021661741671741671031663016100917416331165174167195169101711017112316817416300161741633116130157003311570023133174351743517435174353137174351743531333033313317435174351743531371743517435313730371033812340102381023831333133313331371234030330015174351743900110242113451234017235312931293133303700119541303732293129006302900103015717416310316630165174167123168195169411722051721221724117217517119416910317017417117417112317217417130165321570010302931293129312917435001314130413141195411043194413141175393033002302900331165001921751017112316817516331161003311570023015731157311570033015731157311613015731157311570063116130157174163174163311570032311570051743517435174391954112340001529330010311613116517316310316610216631165102166174163174163311610013115700203129312900243029001312931333137173351743531373133174351743531371023831373037313731371743517435302900161743512340123401743917439313717335174351743531331743531290013133001330290018311573015731157001311613016132157301613116117416331161311613015731157311573116130161311613115700230157311573115731161301573116130161175163174167123168174167301653215700431161311611741631021661031663016531161005132157002301573115700145311571741631741673116930169103170311691731673215730157002311653116530165175163311651731631741631741633115700223029174351033810238174391023831371743531331743531371234019445103421143104310242195413041103381753530290010174353137174351743530330081753512340104317443104319541123403037313331333129302931333133303300110338292900831290043029001312931157311651741671231681941693116931169301693116912316831169194169195169101711017112317241172311731017117417112316828157008174163102166311691951691017119416931165321570043133314110432054411245103461124531451034212340101381753531290093129174353029001531371234012340194411033817435302900731290021231681941692117418417420174103170321652915700130157311651741671231681231681231683016530157002131157002917435001205443041175391743530290031743531371023831370013137292931333137303710338102381234012340314110242314130411753931372929001931290043116110216612316817416710316630161311610081021663116910171205172123172174171122168321653016130161007321573116517316331161006313730371753517435174351743531371743517435313730333133001174353033322900630333133313710238103381733500631291743531371234012340173391753917335313330293129002313730333137313717335313730333133313300130293129008313317439102381743931371743531333133302931293133302900131293129003302931291743517435313717435303331373137303710338313730371753530331743531333133302900731290043129001311651021661031661021663116517416710216631161311573115730157311651741671231681741671021661741633116131161301573116130157311613116117416310216610316610216631165301570012311613016131165174167311651731633215700123116110216631165174163174163311570043015731165174167101714117231173101711941693116500322929001312930293133312931373141304119541314112240176353029001031330017313330371753531330013029002312931371743931411944112340174393137313330333129001312931290015302900631290014311570013016132157001301570018631161174167174167174167174167311651741633115731157311610013016100117416710316610216612316830165311653215700330157311570011021703116917416700117416700232157001831157002017435313317435174353133001174393133174353033174351753530371753531331743530293133001174351023800131410011023812340102381743910338314112340173391033830371753517435001313717439001123403037313731373037314130333133004312900230290012312900131290033029007174353137313730333029312900243129312917435313729290011312900517416717416712316812316810216631157001731157001174163102166123168311653015700131157301571741633116517416331165301611741633116530165311651741671741671231681231681941691231681231681031661741633115730157311613116510216612316812316810216610216631161002321570015311611741633016131157001730293133174351743531331743531331743531371023817439102380011043323717443123401023817435312900273029312900131333029313331333029313717335313710238123400011744317439103381023831371743531333033313331331023800110342101383137313717435313730331743531290023129302900343129002312900531157005311613116511317320417212317217517112216810316610316630165311651231680014117217316331165102166103166301653116100133215731161174163301570012311611741671017111317330173205172411721951691741671741630010311570010302931331743531373037314117439174391743931373137173353129005312900131331743919541104310431024231413137302900103129313717439314110238303331290033129001731161123168123168102166174163174163174163311653016517516317416331161005301573116131165174167174167123168301691751673116500230157004312931371023812340102381033830371753531333033312931333133174353137303731371023810338174393137303317435174353133174353137194411143102421954112240323710238123401944111434144102421043314112340174391743931371023817435313331333029001313717335005312900530157123168311691941691231681231681021660011017110316610316617416710216631165301651031663116510216631165301651751633116530165195169411721017110217017516730165321613015700131157174163311651741671231681941691951691021701951693116912216810316610316610216617416331165102166174167195169301691951691231681741673116517316331161311573015700131157001031331023817439313731373037313710338102381023812340174353137313330290093133174353029001531293129313717439123401023817435313317435102383141314130410011234431371023810338303710338174391743910238174393137313730373137174353137174351023831371743910338102383137303732293133001031331743517435313330290073115712316810217012316831165311613116530165001411721231683116530161174163311653016532161005301610013116929157003311613116117416330161311613115731161301570017731291743517435313730373137313717435313330293133302931291743531331234030371753531373033313330293129302931330013029005312900631290033129001130290031741633116130161001311573115700331161174163311610043015731165194169111711741711021703116910216610216631165311651741633116117416317416331161174163174163311650011741671021661741673116917416730165175163006301570033029174393141174391234030411033817535302931333033175351743517439174391234010238313717435313710238174391743910242114320544184462046114710473145304512344175431744330411753910238313731330043029007312900531157174167123168101711741711231724117610171101711951693116930169103170102170411721231724117217417117417131169194169123168311653016532161301613215700130161001311650013116911217317517110217017516731157007311651021661021701117141172411721021701741673116517316331161174163102166321613015731157002301570030302931331743517435313730333133313317435174353137303317435174353133174351743531330025302900271741631231683015700103015700131157123168194169103170123168173163311570033115730161001311653116517316331165102166174167311653116530161005321570023129313719441114310431024211431224017539313700131413037313710238313729293133001031165174167174167174163174163005210216612316819516912316817216331157001431161311651731633115700831165102166101711751630011321571741631021661031663016531165311573116100131161301611741633116131157002831161311691941693116910216632157002031293141414400130413429006302931291743517435313712340304111432054412344943103383133004131161311613016117416331165174163311651731631741633116131161311571741631021663116131161001117416331161311573015700143116117416310216631165102166175163311613015700131157311570013301570053115700231290011234017439102383137313710238313710238102383137175353037103381023831373137303331330077174351743531373037313710338303731333129002231293129302931290021741630033312931333029001217435313730371033831373033302900731331234019441103423141304131370011313717439123403141102383037002232290013116531169173167103166301651751633116530169103170123172194173111754117610179311731021701017112316817416712316817416712316831169301691951691021663115700631157007311570021741631021661231683116500263133123401134504431522454823649404872491034610471134594331413137312900123029001311611021661231683116910171174171123172174171102170195169101711021701951691741671741671031661741671741673116919416910317012216819516910216617416717516317416300817416319516992175311773017721174311690033415717416310216617516331165301613015700123115700103129174351023819541414431450448250255471034611245001205481043314110431744319545204610346304517543194413137313300131290015312931157102166123168311693016931169174167123168103166102166174163311573115700131157301613116117416310316630165311651741630013115731157174163174163311651021661231681231681231681231681221681231681231681741671031663016100131161174163311653116517316331157001331333033174353137313730371753531331743517435303331333129312900131333029313317435313717335313717435174353133002550061302931371023831371023831373137303731371023800110338104312340123401234010238123401234010238123401234017439174391743930331743531333129006302900131293133001311611741671231681231681741673016517516317416331157311653016510316631169122168311691951693016912316817516730165175163008311611741631021661751633016100232157004301573115700331157002030157003131157002174351743912340313717335006313331371743917439123403141101383137313700130290011312900231290010102166001103170194169311691231681741671021663116100717416717416731169411721017110217019516910216617416332157008174163102166123168123168174167174163311573015700331157001311613015717416331161311613016131165123168174167174167102166103166173163311653116517316317416317416331161174163311651021663116510216631165102166321613016132157003230157007102381743910338313729293129005302900331290083115731161301573116130157311573116130157004311570033015700123029174353141174391944110342414410431043174431954131411733910338292931290063029007301573116130157174163174163174163174167311610043115717416331165311653016531165311651741631741631741633016131161311613015731157311570023116130161311613116131161301573115700253015731165123168301693116910316630161001031157311610093116131165301651031663016532161301610013115700931157311573116510216612316831169194169123168103166301610028301573115700331157003301570018302917439414417447154492044811474144103383029001731157174163311613116117416331165102166195169101711017110217011171301691231683116531161311573115731161174163102166311651021661031663016517516331165301651031660011231681731630013115700117416331165102166103166123168173167175167102166311653016131157004311573015717416317416317416331165174163174163001102166001232157007311570033115700431333133303331290051743510338304111432054420444205442054410433141174391743912340123401944131411744317443174434144114319441314112340174391234017339103383137303717535303331290017312900517416317416710217012317220517212317219416931161002311570013116510216617416731169311691017119416931169311653015700631157311653016517516710216610216631161001731157001513115731161001301570023115700131157001311610013015731161301573115700131157001930157311573116130157311573115730157311573116130157174163311613116130157311613015731157311573016100132157005174163311573015731161004301573115731161001301570073115700931161301613215700330157311570013115717416300131157002550098301570013116910216600133133302931290013313730373141314112340122401234012340314119441114319441314112340123403037174393137313717435302900231290093029001312900231157174163311611741633016100117416731165311613016117516317416310216610317029161301610033215700131161301613116131161301611751633016531165311653116517316317416317516330161311573115700131157301573116117416331165301653116510316610216631165301610011311570063115700217435195412054411245103461944517543194411033829290073129001302900131741631021661031661231683016931169123168174167311653116530165103166102166001195169173163301573115700331157001430157102166175167194169195169194169123168103166311613015700831157001174167174167174167174167174167103166301610010321570041021663116531157002417416331165174167123168174167102166174163003631157008311613116512316810171411724117230169176163008174394144102461744720548195492454820548123484148104720544174433141102383137174350053029002312900163116117416310216610317041172205172122172205172195173001235177321734017219616917316717416710316617416717416731169123168411720011121731851741017112317228161003311570083115700430157005302900131290013137303331293133303332291743510238001103422354900114450204441034219541173391234010338173353133312900230290014312900193129004311613116910171174171411721741711741714117210171103170102166301570023103383041314504423651102502354982483145195413137323300130290023129005302900131290093129005917416731165102166311653115700431161102166174167195169123168194169311691231681021664117200117416731169122168123168311691021704117241172111713016910316600731157301613116512316800203015700153015717416331165174167174167174167174167103166301651031661731631031663016510316617416712316812316819416910317017417112317641172102170101713116917316717416300731157004311573133174431844620548174511025021502464810473045195411753500531290063033322931333029003312900331161102170205172184174821761741751131731941691031663115700106312910238103421944119541174391023817435313317435174353133174351743517435303331333129312900231331743531371733510338173351234030290093129004030290041741633116131165301651751633016510316631165173163174163321573015731161174163174163102166311651031661731633116530165103166102166001123172102166103166301653116131161311573116130157009174163311613116510216610216617516710216617416717416317416331157311573115700130157311573115730157001311570013115700273115730157311570013115700125301570043133303317435174353137313300110238313331371743517435303317435313300431290023129312930333229302931331743517435312931290071743512340104341441043314131373033313300113029312931330093029313710238103381733517435312931290093129001302900331290023116131165102166174167174167001311691731633116131165301653116510316612316812316812216831169123168311693016919516910217011171411721017120517230173205172205172205172102170123168311652915700531157004174351033812340304110342414410433141173393137174350013129312900117435102420011034641449431034210431743531290051743531371023812340195411024210242114312344104320544173431954131411013810338123401944110342414441441043194411753917435313700117439314110238303300430290013129002312900131157311570023015700131161301570053116117416331165174167311693016917417141172205172102174113173102174185174184174184174103174301733117311171123172411721231721731711031703016910316631157001331157008231333129302900471743500112340174351743517435174351743531373137001102381743931373037323330293129006313317439314119441104319541314112340122401753910238175353137303731373137174351023800532290033129003302900430157174163174163311653116530165103166301651751631741633116130161175163174163311653016531165311651021663116531165301653215730157001231161174163102170001103170123168102166174163301610013115700131157311570013115700830161174167195169174171101711741713116910216600143115700133115717416310216617416717516730165175163301611741633116512316817416731169173167103166291570013115731161311651021661741671741671741673116517416710216610316617416331161001430157311613116517416717416712316817416730165311610011311570010312930293129313300230293129174351743517439174353141314518446204619545123443041175390053129302900331293129313330291743531293133303300103129003824810477249164482554719545104310238303300331293129302931330011312900831161311611741671231681017110171411724117212317212317241172101711941693116917416712316831169194169103170174171174171101711951691021663016531165311613115731161301613116531165173163311651741673115700303015700381743510238174391234031411234017339123403141123401743912340102383037323330290018302912340195451744731492454804821464144102381753500917416317416719516930169195169102170311691951691941691231681021661751630091741633116131165174167174167311691941691017141172205172113173194173211741941732117430173113173113173204172411721031701031661741630011311570053115700143312900117435174391033810238313730371753500163133313712340194411743910338174350011023812340102381753930371753517435001231371023812340174350063029006311613015731161301573116117416317416331165102166103166174167174167301653116531165311610043015700130157001731157001631161311613016131157311613015731161001311570013301610011031663016510316610216617416332157001301570053115717416310216610316610216610316617416712316812316812216810316610316631165001194169123168174167195169002121753517435313317439313700118446001104700131492054412344194413041103381753530290063129002312930290023116110217012317292175017692175185174102174195173123172917110316617416300213015730291743931411043414417443104310342123401023830373133312900631331023831414144314520444123441034219541173391234010238103383037175390011234029333129312931333029174353133102381743910338313717335001312900431290023029002312900231161102166311653116517416717416700112317210217412317216417611217311171195169301691751671741671741633116130161174163311691021701231722051721741714117210171102170311691741673116100730157007311570014311611741671231681741714117219416912316831165175163174163174163301610013215700203133102381743917439313731333129001431331743931411024210431143102421954130411234012340313730333133313330293129313330333133174390013141174393141102421024217443195411234030373229004312931290013133002174163103166102166102166175163174163311651741633016131165001123168101711741673116930165123168195169301691031701231681731671031663016531165174167195169001174171201742051722117418417420174205172411721951691231681731633115700731157311570016313710431234418446214604412350123484148947205441034210238313300530290022312900123129002017439001104717543174431043123403037322900331290023029003312900331293029001312900217416317416331161174163311652915731157004311611021661231683116912316810216630165321570073115731371234417447044514931451744319545173393037103381743910238174353129002312900131293129001302900231165102166174167311691741713117310217418417421174101751021741131733117320517210171101711941691031663116530157001031157301570021743510238103383033001231290013129002312900109311570013115700303115700430157003311570013115700130157001311570013116100130157001131157311571741631741633116130161321570013015731161311651731633116131161301573116100531157005301570043115700711743517435313717435303331290012103381744341442054410431944117439323330293029001312931333029312900431290023129007302900173129001631290043029008301573115700831161301573116117416317416317416317416331165311653016510316630165175163311653016531161174163311613116131165001194169103166123168102166174167311653116131161004730157311571741633115731157301573115700131157311611741631741633015700117416317416310316630169411721231721231724117210171195169194169123168174163311610063116131165174167311693016912316831165311570093115731291234017443414431411023830333129001302931333133004303331371023817439123401234017439102381033817435302900831293137102381234012340194411753910238313700117435001630290081234017443113453045001195451023831333029002312900131330013029174351743531373137102381743910238175350053129002312900130290013129312900230293129312900131290021031661021701741712117492175101752017420517241172195169311691231681021661731633116131157311570020301570043115700217435314117439194411954110242195411944110342102421034219441314112340174390011733500423129001131161301611741633116531165301651031663016531165174163311611741631741631031661021661021661231681741671231681741671741631741631741631741631741633116531165102166001174167123168311653016131157001930157103166001123172301691951693116930169123168103166123168123168122168311691017132165173163174163174163311613115700481743920544205443045123441234419541123401733931371743517435313331290063129001302900631161301613115700193115731161174163301613116131157008174163311653116530165175163301613115700131157001311610013015717416331161174163311651021661741671031663016531165311570052311573016131165174163174163311570043115700930157002331161174167101710010429293029001312931290033116130161311610013115700131023812340314130370030313331333137303719541102421043195411954130411034230411954110242314131411023810238313332293029312917435174351023833290043029001301571741631031661741673116912216819516919516930169103170102170311691741673016531165174163174163311651021661741673116912316810216617416331161004301570023115700631161301573115730157311573115730157001311570043115700131157007313331333137174391743912340174390013041333300330290043129002131157102166103170411724117210217031169173167001174167321573115730161311611741631741633116510216610316612316817416717416731169122168103170311691731671741630013116131161102166311691741711231721741711021701031663015700831157004301570023115700231331023819541414420544304520544414410431143104317443104310338174353029312917435174391024212344195451844641482464830494148185463141102380013229001717416341172411767217710217815417711217716417692175311731741711231681741673216130157002311570013123168411721131734117692175102174205172301691031661741630013115717416331157311610013015700313115700703129312900330293137313712340123401224017635302900253133174353137173351753530371234019541174430011024600111431944117539313729290033029001312900331290013129001302900231161123168174167174167123168174167174167301653116131161311573115730157174163174163311613116130161311613116117416317416717416317416331157311613115700130157001311570026311653016531165311653016132157301573115731161301611751633016131161311573015731157001311613015731161174163174163102166103166102166103166174167173163175163301573115700430157311573116130161009321570083129313330333137313717335322900917416717416717416717416710316617416330161175163174163301613116100103115712316810171001311731731670012313717335313717435174353137303731371023812340103381023817435313300463116517416700131173101166002031157007174391234031411023830330023129174351743510238174390014144314131411224010338175350063029002231293137205441733912340102383137313729290026312931331743917439313729290073129003311651021661231683116529157001311611741631741631741633116517316317516330165321613016117416331165123168123168102166301610014321571741630011741714117231169102166301570043115731161301611741631741631751633016100131157004311570015311570027313700117439313710238174351234031371023800110242175391023831371743531293029007313331371023831373137173353129001217435102381234017439103381733500931290010301610013215700181741631231681231681021663116517316331161311613016117516300130157002311650011017131169174171101714117219516930169311650019321570023115700531371234030413141123401033817439174391234012340304117539303731371753530373137313331293133002430290015311573015731161311611741633116529157311570043116117416317416317416317416317416331161301611741633116131161311613015700173116130161311650013116130157311613016100131161002731157005311570030312917439195411744341441744319441195411743910238102381753531330051302900330157311611741631741633116510216610316617416710216617416331157004231157006313331333033312931293129302931293129007313330331743531333133302931290013133313330333129312931333029313330290020312900433115730157311573115731161301573116130157003311570013115730157001311570020311610013116500255002550025132293129001431293029313300231290012174351743531333029001231331743531333029001312930293133302931331743531293029001174351743531371743517435001631293029313300131293029312931293029313331293029313331333137303731371743910238175353129003031157311610013116510216631165301610023116131161174163174163174163311651021661231681231681021663115700123015700131157001311570023015700431157311570041741631021663116531165174163174163174163311613016100255003817435313730371743910338174391743917435313730331743517435313317435102381234019541205441844692470481844612344175431234017235004322930290051741631021661031661741671231681741671021663116517416317416317416331165301651031661231683016910317041172411721741711017110217010317019416912316800119516917316331161174163311611741633116510216617416731169123168102170103170301693116931165173163006311570033115700131157311570023015700131157003312912340123401743910238174391743917439103381023819541172353129313330293129004931157301570010311571231681231681941691231681231681031663016531161005311611741633116131161002617416317416331165301613116130157311573015731157311611741633116517316331161311570093115700310338194411234420544304117635303331293133312900103029313330290019311651741673016532161001017416310216610316612316812316812216817516710216610316630165175163311570043116130157311570083015700131157006313330291743500123129001313300921023831411944111431944119541123401944131411234012340173391033831371234010238303710338174393137173353133006312900331157311613016100631161311571741631741631741631741633116131161301613116117416331161311613016131157311573115731161174163174163311653016517416712316817416712316812316810216631165311610053015700731161311653016517416712316800117417117416731165311653016131157311613015731165102166103166102166102166311653115700931157009311570041954119441184467249194493149246481124532411733500730290033015717416712316819516930169195169102170311691017117417141172411721951691941691751671731633116131161301573116130161001031157003311612051721941732051760012151810010180174171195169301610083115700831157002312917439195412054411245314541441043174393229004431333033174351743531333129008102381034211245164480011053824812348113453145414417443195411024212340174393141173391234017439103383037323300330290013029004312900144117212317220174205172195169301691231681751671021701031704117220517220174001225178211741017500111175122168311610099174393137102383137313730373133174353133313710238174391234010242174431143174431944131411024200834293129007311611741633116530165311651741633116117416317416331161174163301573115700231161311651741671231681021663116529157001311570043015700131157311573015731161311573116130157311570043015700131330013033174353137174393137303300131290073115700330157311573116131165301651031661741630083015731157301573116117416331165102166123168123168173163174167103166102166102166103166311651731633115700273116117416310216631165311610013102166174167195169101711017110317019416919516917416730165321570011311570035174163102166123168123168102166321570022174353137174393137173353133313330290011743917435313700131411733917539304110338174393137174353137174351743531330013033322917435313317435174351743531373037175351743531330021174351043001105100172490011024233290093116110216631165102166175163311570012311653016517516331165301653116531165174163311653016131161174163174163311651021661021661031661741633015700831157174163174163174163311570061741633116510216631165311651731631741633116531165173163002131157002231161311573015700293029313731371023817439102381753910238102381033817439102381743910338292931290023133004030293116510216610216617516331157008618710012025189020112802317801111910131330151159035161010198013112401013001816901314701515301971530251501813501211501214602614601114702115901412303111520141640181120121150511305121019116602219013115012816902311620915601212703711108711601911601519033133015615001614202018301918101618201618001412102616102315601313301911603164018151014137015140014176020168017139014153021122024111101129035127026148018115010161010121015190151460111118071820121360151950813901814003011330141400151180911309123016149013125017168023110302011901441640161160131220141820511230111570101540516707167014140018116018712551820811702715201214105125513809116016141010112071801671251011119501714801414701415307152071200841255182013152081370255021165013189013190041800719801511040516609163081390181901315081160411701711201718014114025506411710814701818001114209144051380712120101163011119101316201113601211909125513007712220615801014406132081440811880661196024177065117208112106178061520131202011174012118091100131480101174016164091135013148071390411071210151902412070181610591201010163010111601011890131230191810101580518109129051360917009127061470814501612701113301313801113801211101311104167020110011128025502550255026111018113018140012150141702550911720816901818301212001211708118013117402212551101911980231340916301019509140024133014128013131069	")

        const [currentReplay] = await db
            .select({
                id: replays.id,
                ticks: replays.ticks,
            })
            .from(replays)
            .where(and(eq(replays.world, input.world), eq(replays.gamemode, input.gamemode)))
            .limit(1)
            .execute()

        if (currentReplay === undefined || stats.ticks < currentReplay.ticks) {
            console.log(`replay is better, existing ${currentReplay?.ticks}, new ${stats.ticks}`)

            const update = {
                deaths: stats.deaths,
                ticks: stats.ticks,

                model: replayBuffer,
            }

            try {
                await db
                    .insert(replays)
                    .values({
                        id: currentReplay?.id,

                        world: input.world,
                        gamemode: input.gamemode,

                        ...update,
                    })
                    .onConflictDoUpdate({
                        target: replays.id,
                        set: update,
                    })
                    .execute()
            } catch (e) {
                console.log(e)
            }
        } else {
            console.log(`replay is worse, existing ${currentReplay.ticks}, new ${stats.ticks}`)
        }

        return stats
    })
