import { RuntimeSystemContext } from "runtime/src/core/runtime-system-stack"
import { ExtendedRuntime } from "../../runtime-extension/new-extended-runtime"
import { Keyboard } from "./keyboard"
import { Mouse } from "./mouse"

const CHARCODE_ONE = "1".charCodeAt(0)
const CHARCODE_NINE = "9".charCodeAt(0)

function base64ToBytes(base64: string) {
    return Uint8Array.from(atob(base64), c => c.charCodeAt(0))
}

const input =
    "W3sidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4xfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjF9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4xfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjF9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjB9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMX0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC4xfSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjF9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMX0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC4xfSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjF9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMn0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC4yfSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjJ9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMn0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC4yfSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjJ9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjR9LHsidGhydXN0IjpmYWxzZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOmZhbHNlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6ZmFsc2UsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4wOTk5OTk5OTk5OTk5OTk5OH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjA5OTk5OTk5OTk5OTk5OTk4fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4wOTk5OTk5OTk5OTk5OTk5OH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjA5OTk5OTk5OTk5OTk5OTk4fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xOTk5OTk5OTk5OTk5OTk5OH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjE5OTk5OTk5OTk5OTk5OTk4fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xOTk5OTk5OTk5OTk5OTk5OH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjE5OTk5OTk5OTk5OTk5OTk4fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNzk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjc5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNzk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjc5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC44OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuODk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjg5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC44OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuODk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjg5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNzk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjc5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43OTk5OTk5OTk5OTk5OTk5fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNzk5OTk5OTk5OTk5OTk5OX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjc5OTk5OTk5OTk5OTk5OTl9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC43fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC42fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNn0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjZ9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC41fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNX0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjV9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC40fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4zMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjMwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMzAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjotMC4zfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOi0wLjN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMTk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6LTAuMDk5OTk5OTk5OTk5OTk5OTh9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6Mi43NzU1NTc1NjE1NjI4OTE0ZS0xN30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjoyLjc3NTU1NzU2MTU2Mjg5MTRlLTE3fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjIuNzc1NTU3NTYxNTYyODkxNGUtMTd9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4xMDAwMDAwMDAwMDAwMDAwM30seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjEwMDAwMDAwMDAwMDAwMDAzfSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMTAwMDAwMDAwMDAwMDAwMDN9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9LHsidGhydXN0Ijp0cnVlLCJyb3RhdGlvbiI6MC4yMDAwMDAwMDAwMDAwMDAwNH0seyJ0aHJ1c3QiOnRydWUsInJvdGF0aW9uIjowLjIwMDAwMDAwMDAwMDAwMDA0fSx7InRocnVzdCI6dHJ1ZSwicm90YXRpb24iOjAuMjAwMDAwMDAwMDAwMDAwMDR9XQ=="

export class ModuleInput {
    private keyboard: Keyboard
    private mouse: Mouse

    private rotationSpeed = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.5, 3.0]
    private rotationSpeedIndex = 2

    private precomputed: RuntimeSystemContext[]
    private iter = -1

    constructor(runtime: ExtendedRuntime) {
        this.keyboard = new Keyboard()
        this.mouse = new Mouse(runtime)

        this.onContextMenu = this.onContextMenu.bind(this)
        document.addEventListener("contextmenu", this.onContextMenu)

        this.onKeyboardDown = this.onKeyboardDown.bind(this)
        window.addEventListener("keydown", this.onKeyboardDown)

        this.precomputed = JSON.parse(atob(input))
    }

    dispose() {
        this.keyboard.dispose()
        this.mouse.dispose()

        document.removeEventListener("contextmenu", this.onContextMenu)
        window.removeEventListener("keydown", this.onKeyboardDown)
    }

    rotation() {
        return this.iter < this.precomputed.length ? this.precomputed[this.iter].rotation : 0
        // return this.mouse.rotation() + this.keyboard.rotation()
    }

    thrust() {
        return this.iter < this.precomputed.length ? this.precomputed[this.iter].thrust : false
        // return this.mouse.thrust() || this.keyboard.thrust()
    }

    onPreFixedUpdate(delta: number) {
        ++this.iter
        this.keyboard.onPreFixedUpdate(delta)
    }

    onKeyboardDown(event: KeyboardEvent) {
        if (event.repeat) {
            return
        }

        if (event.key.charCodeAt(0) >= CHARCODE_ONE && event.key.charCodeAt(0) <= CHARCODE_NINE) {
            this.rotationSpeedIndex = event.key.charCodeAt(0) - CHARCODE_ONE

            this.keyboard.setRotationSpeed(this.rotationSpeed[this.rotationSpeedIndex])
            this.mouse.setRotationSpeed(this.rotationSpeed[this.rotationSpeedIndex])
        }
    }

    private onContextMenu(event: Event) {
        event.preventDefault()
    }
}
